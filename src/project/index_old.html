
<html>  
<head>  
	<meta charset="utf-8">  
	<title>A simple specctrum</title>  
</head> 


<body>  

    <fieldset>
        <legend>Read files：</legend>
		<input type="file" id="file" name="file" size="50" 
		onchange="getPath()" />
		<input type="hidden" id="rawFilePath" name="rawFilePath"><br />
		<input type="submit" value="Submit" onclick="filePathPost()">
    </fieldset>
    <label>Scan=</label>
    <select id="Select">
	</select>
    <input type="button" value="Download" id="Download_as_png" onclick="downloadPng()" />
    <br/>
	<!-- <textarea name="content" id="content"></textarea> -->

<div class="container" id="container">
	<svg>
		<style type="text/css">
			.axis path,
			.axis line{
				fill: none;
				stroke: black;
				shape-rendering: crispEdges;
			}

			.axis text {
				font-family: sans-serif;
				font-size: 11px;
			}

			.MyText {
				fill: red;
				text-anchor: middle;
				font-size: 10px;
			}
			.MyTextMZ {
				fill: red;
				text-anchor: middle;
				font-size: 10px;
			}
					
			.container{
			    height:80%;
			    width:80%;
			}

		</style>
	</svg>
</div>

<script>
	function getPath() {
		var filename = document.getElementById('file').value;
		document.getElementById('rawFilePath').value = filename.substr(12, filename.length - 12);
	}
    function filePathPost(){
        var xhr=new XMLHttpRequest();
        xhr.open("POST","http://127.0.0.1:8081/file_path_post",true);
        xhr.onreadystatechange=function(){
            if(xhr.readyState==4){
                if(xhr.status==200){
                    // document.getElementById("res_scan").innerHTML=xhr.responseText;
                    console.log(xhr.responseText);


					var scanNum = 0;
					var allScan = xhr.responseText.split("\t");
					// console.log('allScan length: '+allScan.length);
					for (var i = 0; i < allScan.length; i++) {
						if (allScan[i].length > 1) {
							var singleScan = allScan[i].split(",");
							scanIndex[scanNum] = Number(singleScan[0]);
							scanList[scanNum] = Number(singleScan[1]);
							// console.log(scanNum+","+singleScan[0]+","+singleScan[1]);
							// console.log(scanNum+","+scanIndex[scanNum]+","+scanList[scanNum]);
							addScan(singleScan[1]);
							scanNum++;
						}
					}
					scanChanged()
                }
            }
        }
        xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
        console.log("filePath="+document.getElementById("rawFilePath").value);
        xhr.send("filePath="+document.getElementById("rawFilePath").value);
    }
    function scanPost(nowScanIndex){
        var xhr=new XMLHttpRequest();
        xhr.open("POST","http://127.0.0.1:8081/scan_post",true);
        xhr.onreadystatechange=function(){
            if(xhr.readyState==4){
                if(xhr.status==200){
                    // document.getElementById("res_spec").innerHTML=xhr.responseText;
                    // console.log(xhr.responseText);	

					var peakNum = 0;
					var allPeak = xhr.responseText.split("\t");
					for (var i = 0; i < allPeak.length; i++) {
						if (allPeak[i].length > 1) {
							var singlePeak = allPeak[i].split(",");
							peakData[peakNum] = [Number(singlePeak[0]),Number(singlePeak[1])];
							peakNum++;
						}
					}
					convertData();
					addPeaks();
					addTexts();
					addAxis();
            	}
            }
        }
        xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
        console.log("nowScan="+nowScan);
        console.log("nowScanIndex="+nowScanIndex);
        xhr.send("nowScanIndex="+nowScanIndex);
    }
</script>

<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>  
<script>
	var nowScan = -1;
	var scanList = [];
	var scanIndex = [];
	var peakData = [];
	var annotationData = [];
	var scanSelect = document.getElementById("Select");
	scanSelect.onchange = scanChanged;

	// 1.判断select选项中 是否存在Value="paraValue"的Item 
	function jsSelectIsExitItem(objSelect, objItemValue) { 
		return false
		// var isExit = false; 
		// for (var i = 0; i < objSelect.options.length; i++) { 
		// 	if (objSelect.options[i].value == objItemValue) { 
		// 		isExit = true; 
		// 		break; 
		// 	} 
		// } 
		// return isExit; 
	} 

	// 2.向select选项中 加入一个Item 
	function addScan(scan){

		//判断是否存在 
		if (jsSelectIsExitItem(scanSelect, scan)) { 
			// console.log("该Item的Value值已经存在"+scan); 
		} else { 
			var varItem = new Option(scan, scan); 
			scanSelect.options.add(varItem); 
			// console.log("成功加入"); 
		} 
	}

	function scanChanged(){

		svg.call(xZoom.translate([0,0]).scale(1).event);
		svg.call(yZoom.translate([0,0]).scale(1).event);

		var currSelectValue = Number(scanSelect.value);
		nowScan = currSelectValue;
		group_top.selectAll(".MyPeak").remove()
		group_top.selectAll(".MyText").remove()
		group_bottom.selectAll("g").remove()
		group_top.selectAll("g").remove()
		scanPost(scanSelect.selectedIndex);
	}
	// function initSelect(){
	// 	var currSelectValue = Number(scanSelect.value);
	// 	nowScan = currSelectValue;
	// 	scanPost(scanSelect.selectIndex);
	// 	// convertData();
	// 	// addPeaks();
	// 	// addTexts();
	// 	// addAxis();
	// }


	//画布大小
	var width = 1000;
	var height = 400;

	var x = 0;
	var y = 0;
	var xs = 1;
	var ys = 1;

	var xZoom = d3.behavior.zoom()
		.translate([0, 0])
		.scaleExtent([1, 100000000])
		.scale(1)
		.on("zoom", xZoomed);
	var yZoom = d3.behavior.zoom()
		.translate([0, 0])
		.scaleExtent([1, 100000000])
		.scale(1)
		.on("zoom", yZoomed);

	//开启拖动
	var drag = d3.behavior.drag()
	    .on("dragstart", dragstarted)
	    .on("drag", dragged)
	    .on("dragend", dragended);
	var dragx = 0;
	var dragd_zoom = 0;
	var dragd_drag = 0;

	var container = d3.select("body")
		.select(".container");


	//画布周边的空白
	var padding = {left:100, right:100, top:50, bottom:50};

	//在 body 里添加一个 SVG 画布	
	var svg = container.select("svg")
        .attr("preserveAspectRatio", "xMidYMin meet")
        .attr("viewBox", "0 0 "+width+" "+height)
		.attr("width", "100%")
		.attr("height", "100%")
        .on('dblclick.zoom', init)
      	.call(drag);
    var group_top = svg.append("g")
        .call(yZoom);
    var tect_top = group_top.append("rect")
    	.attr("x","0")
    	.attr("y","0")
    	.attr("width",width)
    	.attr("height",height - padding.bottom)
    	.attr("style","fill:rgb(255,255,255);stroke-width:0;stroke:rgb(0,0,0);fill-opacity:0");
    var group_bottom = svg.append("g")
        .call(xZoom)
        .on('mousedown', function(){
			svg.attr("cursor","move");
        })
        .on('mouseup', function(){
			svg.attr("cursor","default");
        });
    var tect_bottom = group_bottom.append("rect")
    	.attr("x","0")
    	.attr("y",height - padding.bottom)
    	.attr("width",width)
    	.attr("height",padding.bottom)
    	.attr("style","fill:rgb(255,255,255);stroke-width:0;stroke:rgb(0,0,0);fill-opacity:0");

	var peakData = [];
	var annotationData = [];
	
	var xDomain;
	var xRange;
	var xScale;
	var yScale;
	var xAxis;
	var yAxis;


	var peakmass = [];
	var peakintensity = [];
	var maxPeakintensity = 0;
	var notesmass = [];
	var notesintensity = [];
	var notestype = [];
	function convertData() {
		var i = peakData.length;
		while(i--) {
			peakmass[i] = peakData[i][0];
			peakintensity[i] = peakData[i][1];
		}
		maxPeakintensity = d3.max(peakintensity);
		var i = peakintensity.length;
		while(i--) {
			peakintensity[i] = peakintensity[i] / maxPeakintensity
		}
		i = annotationData.length;
		while(i--) {
			notesmass[i] = annotationData[i][0];
			notesintensity[i] = annotationData[i][1] / maxPeakintensity;
			notestype[i] = annotationData[i][2];
		}
		console.log(peakmass);
		console.log(peakintensity);
		console.log(notesmass);
		console.log(notesintensity);
		console.log(notestype);

		xDomain = d3.max(peakmass) * 1.1 - d3.min(peakmass) * 0.1
		xRange = width - padding.left - padding.right
		//x轴的比例尺
		xScale = d3.scale.linear()
			.domain([0,xDomain])
			.range([0, xRange]);
		//y轴的比例尺
		yScale = d3.scale.linear()
			.domain([0,d3.max(peakintensity)])
			.range([height - padding.top - padding.bottom, 0]);

		//定义x轴
		xAxis = d3.svg.axis()
			.scale(xScale)
			.orient("bottom")
	        .ticks(10);
			
		//定义y轴
		yAxis = d3.svg.axis()
			.scale(yScale)
			.orient("left")
    		.tickFormat(function(d) { return Math.round(d * 100 / d3.max(peakintensity)) + "%"; })
        	.ticks(10);

	}
	convertData();


	var peaks = group_top.selectAll(".MyPeak")
	//添加peaks元素
	function addPeaks() {
		peaks.data(peakmass)
		.enter()
		.append("line")
		.attr("class","MyPeak")
		.attr("transform","translate(" + padding.left + "," + padding.top + ")")
		.attr("x1",function(d,i){
			return xScale(d);
		} )
		.attr("y1",function(d,i){
			return yScale(peakintensity[i]);
		})
		.attr("x2",function(d,i){
			return xScale(d);
		})
		.attr("y2",height - padding.bottom - padding.top)
		.attr("stroke",function(d,i){
			if(notesmass.indexOf(d) != -1){
				return "steelblue";
			}else{
				return "black";
			}
		})
		.attr("stroke-width","2")
		.on("mouseover",function(d,i){
			over(this,d,i);
		})
		.on("mouseout",function(d,i){
			out(this,d);
		});
	}
	var textMZ;
	var textIN;
	// addPeaks();
      	// .call(drag);
	function over(t,d,i){
			console.log("d:"+d);
			console.log("i:"+i);
			console.log("x:"+xScale(d));
			console.log("y:"+(yScale(peakintensity[i])-10));
			var tmpData = [[d,yScale(peakintensity[i])]];
			d3.select(t).attr("stroke","red")
				.attr("stroke-width","3");
			textMZ = group_top.selectAll(".MyTextMZ")
				.data(tmpData)
				.enter()
				.append("text")
				.attr("class","MyTextMZ")
				.attr("transform","translate(" + padding.left + "," + padding.top + ")")
				.attr("x", function(d) {
					var tmpx = (xScale(d[0]) + dragx) * xs + x;
			  		if (tmpx > 0 && tmpx < xRange){
			  			return tmpx;
			  		}else{
			  			return -1000;
			  		}
				})
				.attr("y", function(d) {
					var yHight = height - padding.bottom - padding.top - d[1];
			  		var tmpy = height - padding.bottom - padding.top - yHight * ys;
			  		if (tmpy > height - padding.bottom){
			  			return height - padding.bottom - 20;
			  		}else if (tmpy < 0){
			  			return 0 - 20;
			  		}else {
			  			return tmpy - 20;
			  		}
				})
				.text(function(d){
					return "M:"+d[0];
				});
			textIN = group_top.selectAll(".MyTextIN")
				.data(tmpData)
				.enter()
				.append("text")
				.attr("class","MyTextMZ")
				.attr("transform","translate(" + padding.left + "," + padding.top + ")")
				.attr("x", function(d) {
					var tmpx = (xScale(d[0]) + dragx) * xs + x;
			  		if (tmpx > 0 && tmpx < xRange){
			  			return tmpx;
			  		}else{
			  			return -1000;
			  		}
				})
				.attr("y", function(d) {
					var yHight = height - padding.bottom - padding.top - d[1];
			  		var tmpy = height - padding.bottom - padding.top - yHight * ys;
			  		if (tmpy > height - padding.bottom){
			  			return height - padding.bottom - 10;
			  		}else if (tmpy < 0){
			  			return 0 - 10;
			  		}else {
			  			return tmpy - 10;
			  		}
				})
				.text(function(d){
					return "I:"+peakintensity[i]*100+"%";
				});
	};
	function out(t,d){
		d3.select(t)
			.transition()
	        .duration(500)
			.attr("stroke",function(d){
				if(notesmass.indexOf(d) != -1){
					return "steelblue";
				}else{
					return "black";
				}
			})
			.attr("stroke-width","2");

		textMZ.remove();
		textIN.remove();
	};

	//添加注释文字
	var textshiftx = 0;
	var textshifty = -5;
	var texts = group_top.selectAll(".MyText")
	function addTexts() {
		texts.data(notesmass)
		.enter()
		.append("text")
		.attr("class","MyText")
		.attr("transform","translate(" + (padding.left + textshiftx) + "," + (padding.top + textshifty) + ")")
		.attr("x", function(d,i){
			return xScale(d);
		} )
		.attr("y",function(d,i){
			return yScale(notesintensity[i]);
		})
		.text(function(d,i){
			return notestype[i];
		});
      	// .call(drag);
	}
	// addTexts();

	function addAxis() {
		//添加x轴
		group_bottom.append("g")
			.attr("id","xAxis")
			.attr("class","axis")
			.attr("transform","translate(" + padding.left + "," + (height - padding.bottom) + ")")
			.call(xAxis); 
			
		//添加y轴
		group_top.append("g")
			.attr("id","yAxis")
			.attr("class","axis")
			.attr("transform","translate(" + padding.left + "," + padding.top + ")")
			.call(yAxis);
	}
	// addAxis();


	function xZoomed() {
		xs=d3.event.scale;
		x=d3.event.translate[0] + padding.left * (xs - 1);
		// console.log(d3.event);
		// console.log(d3.event.translate);
		// console.log(d3.event.scale);
		// console.log("translate(" + d3.event.translate + ") scale(" + d3.event.scale + ")");
		// container.attr("transform", "translate(" + d3.event.translate[0] + ",0) scale(" + d3.event.scale + ")");

		reset();
	};
	function yZoomed() {
		ys=d3.event.scale;
		// y=d3.event.translate[1] + padding.top * (ys - 1);
		// console.log(d3.event);
		// console.log(d3.event.translate);
		// console.log(d3.event.scale);
		// console.log("translate(" + d3.event.translate + ") scale(" + d3.event.scale + ")");
		// container.attr("transform", "translate(" + d3.event.translate[0] + ",0) scale(" + d3.event.scale + ")");

		reset();
	};

	function init() {
		d3.transition().duration(500).tween("zoom", function() {
		    var xsi = d3.interpolate(xs, 1);
		    var ysi = d3.interpolate(ys, 1);
		    var xi = d3.interpolate(x - padding.left * (xs - 1), 0);
		    var yi = d3.interpolate(y, 0);
		    return function(t){
		      svg.call(xZoom.translate([xi(t),yi(t)]).scale(xsi(t)).event);
		      svg.call(yZoom.translate([xi(t),yi(t)]).scale(ysi(t)).event);
		 	}
  		});

	}

	function reset() {
	  	group_top.selectAll(".MyText")
	  	.attr("x", function(d,i){
	  		var tmpx = (xScale(d) + dragx) * xs + x;
	  		if (tmpx > 0 && tmpx < xRange){
	  			return tmpx;
	  		}else{
	  			return -1000;
	  		}
	  	})
	  	.attr("y", function(d,i){
			var yHight = height - padding.bottom - padding.top - yScale(notesintensity[i]);
	  		var tmpy = height - padding.bottom - padding.top - yHight * ys;
	  		if (tmpy > height - padding.bottom){
	  			return height - padding.bottom;
	  		}else if (tmpy < 0){
	  			return 0;
	  		}else {
	  			return tmpy;
	  		}
	  	});
	  	group_top.selectAll(".MyPeak")	
		.attr("x1",function(d,i){
	  		var tmpx = (xScale(d) + dragx) * xs + x;
	  		if (tmpx > 0 && tmpx < xRange){
	  			return tmpx;
	  		}else{
	  			return -1000;
	  		}
		} )	
		.attr("y1",function(d,i){
			var yHight = height - padding.bottom - padding.top - yScale(peakintensity[i]);
	  		var tmpy = height - padding.bottom - padding.top - yHight * ys;
	  		if (tmpy > height - padding.bottom){
	  			return height - padding.bottom;
	  		}else if (tmpy < 0){
	  			return 0;
	  		}else {
	  			return tmpy;
	  		}
		} )
		.attr("x2",function(d,i){
	  		var tmpx = (xScale(d) + dragx) * xs + x;
	  		if (tmpx > 0 && tmpx < xRange){
	  			return tmpx;
	  		}else{
	  			return -1000;
	  		}
		});
		// var dragd = xDomain*x/(xRange*s);
		dragd_zoom = xDomain*x/(xRange*xs);
		//x轴的比例尺
		var xScale_new = d3.scale.linear()
			.domain([0 - dragd_zoom - dragd_drag,xDomain/xs - dragd_zoom - dragd_drag])
			.range([0, xRange]);
		//定义x轴
		var xAxis_new = d3.svg.axis()
			.scale(xScale_new)
			.orient("bottom")
        	.ticks(10);
		group_bottom.select("#xAxis")
			.call(xAxis_new); 
		//y轴的比例尺
		var yScale_new = d3.scale.linear()
			.domain([0,d3.max(peakintensity)/ys])
			.range([height - padding.top - padding.bottom, 0]);
		
		//定义y轴
		var yAxis_new = d3.svg.axis()
			.scale(yScale_new)
			.orient("left")
    		.tickFormat(function(d) { return Math.round(d * 100 / d3.max(peakintensity)) + "%"; })
        	.ticks(10);
		group_top.select("#yAxis")
			.call(yAxis_new); 

	};

	function dragstarted() {
	  d3.event.sourceEvent.stopPropagation();
	  d3.select(this).classed("dragging", true);
		// console.log(d3.event);
		svg.attr("cursor","move");
	}

	function dragged() {
		// console.log(d3.event);
		dragx += d3.event.dx/xs;
		dragd_drag = xDomain*dragx/xRange;
		reset()
	}

	function dragended() {
	  d3.select(this).classed("dragging", false);
		// console.log(d3.event);
		svg.attr("cursor","default");
	}
</script>  

<script type="text/javascript">
	function downloadPng() {
        // var imgSave = document.getElementById('imgSave');

        var serializer = new XMLSerializer();
        var source = serializer.serializeToString(svg.node());

        source = '<?xml version="1.0" standalone="no"?>\r\n' + source;
        var url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);

        var canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;

        var context = canvas.getContext("2d");
        //    context.fillRect(0, 0, 10000, 10000);
        //    context.fillStyle = '#fff';//设置保存后的PNG 是白色的
        var image = new Image;
        image.src = url;
        
        context.drawImage(image, 0, 0);
        var a = document.createElement("a");
        a.download = "fallback.png";
        a.href = canvas.toDataURL("image/png");
        a.click();

		console.log("url:"+url);
		console.log("href:"+a.href);
	};
</script>
</body>  
</html>  